<!DOCTYPE html><html lang="en">

<head>
    <meta charset="UTF-8">
    <title>a chess thing i made</title>

    <!-- libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css"
        crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js" crossorigin="anonymous"></script>

    <style>
        :root {
            --bg: #e6e6e6;
            --card-bg: #fefefe;
            --border: #141414;
            --heading: #111;
            --text: #222;
            --accent: #3b3b3b;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background: var(--bg);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text);
        }

        .app-wrapper {
            width: min(90vw, 560px);
            margin: 3.5rem auto 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
        }

        .brand {
            align-self: stretch;
            display: flex;
            align-items: center;
            gap: 0.85rem;
            font-weight: 700;
            color: var(--heading);
            letter-spacing: 0.02em;
        }

        .brand-logo {
            width: 54px;
            height: 54px;
            border-radius: 14px;
            border: 3px solid var(--border);
            padding: 0.35rem;
            background: var(--card-bg);
        }

        .brand-text {
            font-size: 1.1rem;
            text-transform: lowercase;
        }

        h1 {
            margin: 0;
            font-size: clamp(2.25rem, 4vw, 2.75rem);
            color: var(--heading);
            text-align: center;
        }

        .setup-card {
            width: 100%;
            padding: 2.75rem clamp(1.5rem, 5vw, 3.5rem);
            border-radius: 24px;
            border: 3px solid var(--border);
            background: var(--card-bg);
            display: flex;
            flex-direction: column;
            gap: 2rem;
            box-shadow: 0 32px 55px rgba(0, 0, 0, 0.18);
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .control-group label {
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 0.85rem;
        }

        .colour-choice-grid {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .colour-choice {
            flex: 1 1 110px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.45rem;
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 0.75rem;
            background: #f8f8f8;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .colour-choice img {
            width: 64px;
            height: 64px;
            object-fit: contain;
            padding: 0.5rem;
            border-radius: 50%;
            background: #fff;
            border: 3px solid rgba(0, 0, 0, 0.2);
            box-shadow: 0 10px 22px rgba(0, 0, 0, 0.18);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .colour-choice.active img {
            border-color: rgba(255, 255, 255, 0.85);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.25);
        }

        .colour-choice span {
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        .colour-choice.active {
            background: #1f1f1f;
            color: #fff;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.18);
        }

        .colour-choice:focus-visible {
            outline: 3px solid rgba(0, 0, 0, 0.3);
            outline-offset: 3px;
        }

        select,
        .controls input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 0.85rem 1rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            background: #f9f9f9;
        }

        select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .slider-track {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .toggle-group {
            display: flex;
            gap: 0.75rem;
        }

        .toggle-btn {
            flex: 1;
            padding: 0.85rem 1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: #f8f8f8;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
        }

        .toggle-btn.active {
            background: #1f1f1f;
            color: #fff;
            transform: translateY(-1px);
        }

        .toggle-summary {
            display: flex;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--accent);
            letter-spacing: 0.04em;
        }

        .toggle-summary .divider {
            opacity: 0.4;
        }

        input[type="range"] {
            background: linear-gradient(90deg, #111 0%, #555 100%);
            height: 6px;
            border-radius: 999px;
            padding: 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            background: #fff;
            border: 3px solid var(--border);
            border-radius: 50%;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 22px;
            height: 22px;
            background: #fff;
            border: 3px solid var(--border);
            border-radius: 50%;
            cursor: pointer;
        }

        .range-output {
            font-weight: 700;
            text-align: right;
            letter-spacing: 0.05em;
        }

        .start-button {
            margin-top: 0.5rem;
            align-self: center;
            padding: 0.95rem 3rem;
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            border-radius: 14px;
            border: 3px solid var(--border);
            background: linear-gradient(180deg, #f5f5f5 0%, #bdbdbd 100%);
            color: var(--heading);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.15);
        }

        .start-button:active {
            transform: translateY(1px);
            box-shadow: none;
        }

        #board {
            width: 400px;
            margin: 1rem auto;
            /* Prevent scrolling/panning on mobile when dragging pieces */
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #status {
            margin-top: 1rem;
            font-size: 1.125rem
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: #fff;
            margin: 15% auto;
            padding: 1rem;
            border-radius: 8px;
            max-width: 400px;
            position: relative;
        }
        .modal-content .close {
            position: absolute;
            top: 0.5rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="app-wrapper">
        <div class="brand">
            <img class="brand-logo" src="assets/logo.png" alt="ChessCrunch logo">
            <span class="brand-text">chesscrunch.com</span>
        </div>
        <h1>Game Setup</h1>

        <div class="setup-card">
            <div class="controls">
                <div class="control-group">
                    <label for="playerColourRandom">Colour</label>
                    <div class="colour-choice-grid" role="radiogroup" aria-label="Choose your side">
                        <button type="button" class="colour-choice" data-value="white" aria-pressed="false">
                            <img src="assets/white.png" alt="Play as white">
                            <span>White</span>
                        </button>
                        <button type="button" class="colour-choice active" data-value="random" id="playerColourRandom" aria-pressed="true">
                            <img src="assets/random.png" alt="Random side icon">
                            <span>Random</span>
                        </button>
                        <button type="button" class="colour-choice" data-value="black" aria-pressed="false">
                            <img src="assets/black.png" alt="Play as black">
                            <span>Black</span>
                        </button>
                    </div>
                </div>

                <div class="control-group">
                    <label for="advantage">Starting position</label>
                    <div class="slider-track">
                        <input type="range" id="advantage" min="-12" max="12" value="0">
                        <div class="slider-labels">
                            <span>Disadvantage</span>
                            <span>Advantage</span>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label for="elo">Bot difficulty</label>
                    <select id="elo">
                        <option value="200">Shit</option>
                        <option value="400">Extremely easy</option>
                        <option value="600">Very easy</option>
                        <option value="800">Easy</option>
                        <option value="1100" selected>Moderate</option>
                        <option value="1400">Hard</option>
                        <option value="1600">Very hard</option>
                        <option value="1800">Extremely hard</option>
                        <option value="2000">Candidate Master</option>
                        <option value="2200">International Master</option>
                        <option value="2500">Grandmaster</option>
                        <option value="3000">God</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="minPlies">Game state</label>
                    <div class="toggle-group" role="radiogroup">
                        <button type="button" class="toggle-btn active" data-min="16" data-max="60" data-label="Mid-game">Mid-game</button>
                        <button type="button" class="toggle-btn" data-min="60" data-max="120" data-label="Late-game">Late-game</button>
                    </div>
                    <div class="toggle-summary">
                        <span id="minPliesValue">Mid-game</span>
                        <span class="divider">•</span>
                        <span id="maxPliesValue">16–60 moves</span>
                    </div>
                    <input type="hidden" id="minPlies" value="16">
                    <input type="hidden" id="maxPlies" value="60">
                </div>
            </div>

            <button id="generateBtn" class="start-button">Start Game</button>
        </div>
    </div>
    <!-- Error modal -->
    <div class="modal" id="errorModal">
        <div class="modal-content">
            <span class="close" id="modalClose">&times;</span>
            <p>Sorry, it doesn't appear we could connect to our servers - but you can still play against the bot!</p>
        </div>
    </div>

    <div id="game" style="display: none;">
        <div id="board" style="display: none;"></div>
        <p id="status" style="display: none;"></p>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        /* --------------------------------------------------
           Helper maps (depth, skill, randomness)
        -------------------------------------------------- */
        // track selected player color globally
        let playerColor = 'white';
        function depthForElo(elo) {
            // console.log('Elo:', elo);
            if (elo < 300) return 1;
            if (elo < 500) return 2;
            if (elo < 700) return 2;  // weakened from 3
            if (elo < 900) return 3;  // weakened from 4
            if (elo < 1100) return 4; // weakened from 5
            return 5; // weakened from 6 (1100–1319)
        }

        function skillForElo(elo) {
            // console.log('Elo:', elo);
            // Stockfish Skill Level 0‑20 (0 weakest)
            if (elo < 300) return 0;
            if (elo < 500) return 1;
            if (elo < 700) return 2;  // weakened from 3
            if (elo < 900) return 4;  // weakened from 5
            if (elo < 1100) return 6; // weakened from 8
            return 10; // weakened from 12 (1100–1319)
        }

        function randomChanceForElo(elo) {
            // console.log('Elo:', elo);
            if (elo < 300) return 0.8;  // 60 % random
            if (elo < 500) return 0.4;   // 30 %
            if (elo < 700) return 0.2;   // 10 % randomness for <700
            if (elo < 900) return 0.1;   // slight randomness for <900
            return 0; // ≥900 – deterministic
        }

        /* --------------------------------------------------
           DOM prep – hide board until started
        -------------------------------------------------- */
        document.getElementById('board').style.display = 'none';
        document.getElementById('status').style.display = 'none';
    const minPliesInput = document.getElementById('minPlies');
    const maxPliesInput = document.getElementById('maxPlies');
    const minPliesValue = document.getElementById('minPliesValue');
    const maxPliesValue = document.getElementById('maxPliesValue');
    const gameStateButtons = document.querySelectorAll('.toggle-btn');
    const colourButtons = document.querySelectorAll('.colour-choice');
    let colourSelection = 'random';

        function setGameState(button) {
            gameStateButtons.forEach(btn => btn.classList.toggle('active', btn === button));
            minPliesInput.value = button.dataset.min;
            maxPliesInput.value = button.dataset.max;
            minPliesValue.textContent = button.dataset.label;
            maxPliesValue.textContent = `${button.dataset.min}–${button.dataset.max} moves`;
        }

        gameStateButtons.forEach(btn => btn.addEventListener('click', () => setGameState(btn)));

        function setColourSelection(value) {
            colourSelection = value;
            colourButtons.forEach(btn => {
                const isActive = btn.dataset.value === value;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-pressed', isActive.toString());
            });
        }

        colourButtons.forEach(btn => btn.addEventListener('click', () => setColourSelection(btn.dataset.value)));
        // initialize defaults
        if (gameStateButtons.length) {
            setGameState(gameStateButtons[0]);
        }
        if (colourButtons.length) {
            setColourSelection('random');
        }
        document.getElementById('advantage').value = document.getElementById('advantage').defaultValue;

        /* --------------------------------------------------
           Globals
        -------------------------------------------------- */
        const STOCKFISH_CDN = 'https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.min.js';
        let engine, ready = false, currentElo = 1200;

        /* --------------------------------------------------
           Utility: send command & log to console
        -------------------------------------------------- */
        function sfSend(cmd) {
            console.log('%c[SEND] ' + cmd, 'color:#0a0');
            engine.postMessage(cmd);
        }

        /* --------------------------------------------------
           Inline form submission and API integration
        -------------------------------------------------- */
        document.getElementById('generateBtn').addEventListener('click', async () => {
            // set global player color (handle random)
            const selected = colourSelection;
            if (selected === 'random') {
                playerColor = Math.random() < 0.5 ? 'white' : 'black';
            } else {
                playerColor = selected;
            }
            const elo = parseInt(document.getElementById('elo').value, 10);
            const minPlies = parseInt(document.getElementById('minPlies').value, 10);
            const maxPlies = parseInt(document.getElementById('maxPlies').value, 10);
            
            // Validate min/max turns
            if (minPlies > maxPlies) {
                alert('Min turns cannot be greater than max turns!');
                return;
            }
            
            // calculate signed target from slider (-25 to +25) * 100, flip sign if playing black
            const adv = parseInt(document.getElementById('advantage').value, 10);
            let target = adv * 100 * (playerColor === 'white' ? 1 : -1);

            // hide controls container and show board
            const setupWrapper = document.querySelector('.app-wrapper');
            if (setupWrapper) setupWrapper.style.display = 'none';
            document.getElementById('game').style.display = 'block';
            document.getElementById('board').style.display = 'block';
            document.getElementById('status').style.display = 'block';
            document.getElementById('status').textContent = 'loading...';

            try {
                // stream positions via WebSocket
                // user-provided backend tunnel host (e.g. via localtunnel/ngrok)
                // const BACKEND_HOST = 'localhost:8000';
                const BACKEND_HOST = 'mychessthing.loca.lt';
                // use secure WebSocket when served over HTTPS
                const wsProto = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
                const sock = new WebSocket(`${wsProto}${BACKEND_HOST}/ws/generate_board`);
                sock.onopen = () => sock.send(JSON.stringify({ target, elo, min_plies: minPlies, max_plies: maxPlies }));
                let first = true;
                sock.onmessage = e => {
                    const { fen } = JSON.parse(e.data);
                    chess.load(fen);
                    if (first) { board.orientation(playerColor); first = false; }
                    board.position(fen, true);
                    // status remains 'loading...' while streaming
                };
                sock.onclose = () => {
                    // after streaming, show next turn and start engine
                    const turnMsg = chess.turn() === 'w' ? 'White to move' : 'Black to move';
                    document.getElementById('status').textContent = turnMsg;
                    startGameEngine();
                };
                sock.onerror = () => {
                    // show error modal and fallback
                    document.getElementById('errorModal').style.display = 'block';
                    startGameEngine();
                };
            } catch (err) {
                console.error(err);
                // on connection failure, show modal and allow engine-only play
                document.getElementById('errorModal').style.display = 'block';
                startGameEngine();
            }
        });

        // Function to start the game engine (extracted from original start button logic)
        function startGameEngine() {
            document.querySelector('.controls').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            document.getElementById('board').style.display = 'block';
            document.getElementById('status').style.display = 'block';
            // status remains as set by onclose; engine hook will update once ready

            fetch(STOCKFISH_CDN, { mode: 'cors' })
                .then(r => r.text())
                .then(code => {
                    const blobURL = URL.createObjectURL(new Blob([code], { type: 'application/javascript' }));
                    engine = new Worker(blobURL);
                    hookEngine();
                })
                .catch(err => alert('Failed to load Stockfish: ' + err));
        }

        /* --------------------------------------------------
           Boot engine (original logic moved to startGameEngine)
        -------------------------------------------------- */

        /* --------------------------------------------------
           Handle engine output
        -------------------------------------------------- */
        function hookEngine() {
            engine.onmessage = e => {
                const line = typeof e.data === 'string' ? e.data : e.data?.toString();
                console.log('%c[SF]   ' + line, 'color:#09f');

                if (line === 'uciok') {
                    applyStrength();
                    ready = true;
                    // engine moves when it's engine's turn (opposite of player's)
                    const engineTurn = playerColor === 'white' ? 'b' : 'w';
                    if (chess.turn() === engineTurn) moveEngine();
                    return;
                }

                if (line === 'readyok') return;

                if (line.startsWith('bestmove')) {
                    const best = line.split(' ')[1];
                    chess.move({ from: best.slice(0, 2), to: best.slice(2, 4), promotion: 'q' });
                    board.position(chess.fen());
                    updateStatus();
                }
            };
            sfSend('uci');
        }

        /* --------------------------------------------------
           Apply strength settings each time elo changes
        -------------------------------------------------- */
        function applyStrength() {
            const s = document.getElementById('status');

            // Always set skill level (exists in this build)
            const skill = currentElo >= 1320 ? 20 : skillForElo(currentElo);
            sfSend('setoption name Skill Level value ' + skill);

            if (currentElo >= 3000) {
                // Full engine strength
                sfSend('setoption name UCI_LimitStrength value false');
                s.textContent = 'Full engine strength';
            } else if (currentElo >= 1320) {
                // Limit engine to target Elo
                sfSend('setoption name UCI_LimitStrength value true');
                sfSend('setoption name UCI_Elo value ' + currentElo);
            } else {
                // lower Elo: skill+depth caps
                sfSend('setoption name UCI_LimitStrength value false');
            }
            sfSend('isready');
        }

        /* --------------------------------------------------
           Elo slider change handler
        -------------------------------------------------- */
        document.getElementById('elo').addEventListener('change', () => {
            currentElo = parseInt(document.getElementById('elo').value, 10);
            if (ready) applyStrength();
        });

        /* --------------------------------------------------
           Chessboard init
        -------------------------------------------------- */
        const chess = new Chess();
        const board = Chessboard('board', {
            draggable: true,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
            position: 'start',
            onDragStart,
            onDrop,
            onSnapEnd: () => board.position(chess.fen())
        });

        updateStatus();

        /* --------------------------------------------------
           Mobile touch handling - prevent page scrolling on board
        -------------------------------------------------- */
        function preventMobileScrolling() {
            const boardElement = document.getElementById('board');
            
            // Prevent default touch behaviors on the board
            boardElement.addEventListener('touchstart', function(e) {
                e.preventDefault();
            }, { passive: false });
            
            boardElement.addEventListener('touchmove', function(e) {
                e.preventDefault();
            }, { passive: false });
            
            boardElement.addEventListener('touchend', function(e) {
                e.preventDefault();
            }, { passive: false });
        }

        // Apply mobile touch handling after a short delay to ensure board is rendered
        setTimeout(preventMobileScrolling, 100);

        /* --------------------------------------------------
           Drag callbacks
        -------------------------------------------------- */
        function onDragStart(src, piece) {
            return !chess.game_over() &&
                !((chess.turn() === 'w' && piece[0] === 'b') || (chess.turn() === 'b' && piece[0] === 'w'));
        }

        function onDrop(src, tgt) {
            const mv = chess.move({ from: src, to: tgt, promotion: 'q' });
            if (!mv) return 'snapback';
            updateStatus();
            setTimeout(moveEngine, 200);
        }

        /* --------------------------------------------------
           Engine move logic with randomness
        -------------------------------------------------- */
        function moveEngine() {
            if (!ready || chess.game_over()) return;

            // Chance for a pure random move instead of engine search
            const randChance = randomChanceForElo(currentElo);
            if (Math.random() < randChance) {
                const moves = chess.moves();
                const pick = moves[Math.floor(Math.random() * moves.length)];
                chess.move(pick);
                board.position(chess.fen());
                updateStatus();
                return;
            }

            sfSend('position fen ' + chess.fen());

            if (currentElo < 1320) {
                const depth = depthForElo(currentElo);
                sfSend('go depth ' + depth);
            } else {
                sfSend('go movetime 1000');
            }
        }

        /* --------------------------------------------------
           UI Status helper
        -------------------------------------------------- */
        function updateStatus() {
            const s = document.getElementById('status');
            const turn = chess.turn() === 'b' ? 'Black' : 'White';
            s.textContent = chess.in_checkmate() ? `Game over – ${turn} is checkmated.` :
                chess.in_stalemate() ? 'Game over – stalemate.' :
                    chess.insufficient_material() ? 'Game over – insufficient material (draw).' :
                        chess.in_draw() ? 'Game over – draw.' :
                            `${turn} to move${chess.in_check() ? `, ${turn} in check!` : ''}`;

        }

        // Close error modal when X clicked
        const modal = document.getElementById('errorModal');
        const closeBtn = document.getElementById('modalClose');
        closeBtn.addEventListener('click', () => { modal.style.display = 'none'; });
        // Optionally close when clicking outside content
        window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
    }); // end DOMContentLoaded
    </script>
</body>

</html>