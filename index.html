<!DOCTYPE html><html lang="en">

<head>
    <meta charset="UTF-8">
    <title>a chess thing i made</title>

    <!-- libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css"
        crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js" crossorigin="anonymous"></script>

    <style>
        body {
            font-family: system-ui, sans-serif;
            background: #f3f4f6;
            margin: 0;
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #1f2937
        }

        #board {
            width: 400px;
            margin: 1rem auto;
            /* Prevent scrolling/panning on mobile when dragging pieces */
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
            margin-top: 1rem;
        }
        .controls label {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        .controls input[type="number"], .controls select, .controls input[type="range"] {
            width: 100%;
            padding: 0.5rem;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .controls button {
            padding: 0.75rem;
            font-size: 1rem;
            background-color: #3b82f6;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .controls button:hover {
            background-color: #2563eb;
        }

        #status {
            margin-top: 1rem;
            font-size: 1.125rem
        }
        .container {
            background: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            width: 100%;
            max-width: 600px;
        }
        .slider-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .slider-group label {
            font-weight: bold;
            flex: 1;
            text-align: center;
        }
        .slider-group input[type="range"] {
            flex: 3;
        }
        #advantageValue {
            width: 2rem;
            text-align: center;
        }
    </style>
</head>

<body>
    <h1>a chess thing i made</h1>

    <div class="container">
        <div class="controls">
        <label for="playerColor">Colour:</label>
        <select id="playerColor">
            <option value="white">White</option>
            <option value="black">Black</option>
            <option value="random" selected>Random</option>
        </select>
        <label for="slider-group">I want to start with a(n):</label>
        <div class="slider-group">
            <label for="advantage">disadvantage</label>
            <input type="range" id="advantage" min="-25" max="25" value="0">
            <label for="advantage">advantage</label>
            <!-- <span id="advantageValue">0</span> -->
        </div>
        <label for="elo">Bot Difficulty:</label>
        <select id="elo">
            <option value="200">Shit</option>
            <option value="400">Extremely easy</option>
            <option value="600">Very easy</option>
            <option value="800">Easy</option>
            <option value="1100" selected>Moderate</option>
            <option value="1400">Hard</option>
            <option value="1600">Very hard</option>
            <option value="1800">Extremely hard</option>
            <option value="2000">Candidate Master</option>
            <option value="2200">International Master</option>
            <option value="2500">Grandmaster</option>
            <option value="3000">God</option>
        </select>
        <label for="minPlies">Min Turns:</label>
        <div class="slider-group">
            <input type="range" id="minPlies" min="0" max="60" value="10">
            <span id="minPliesValue">10</span>
        </div>
        <label for="maxPlies">Max Turns:</label>
        <div class="slider-group">
            <input type="range" id="maxPlies" min="70" max="200" value="90">
            <span id="maxPliesValue">90</span>
        </div>
        <button id="generateBtn">Start</button>
        </div>
    </div>

    <div id="game" style="display: none;">
        <div id="board" style="display: none;"></div>
        <p id="status" style="display: none;"></p>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        /* --------------------------------------------------
           Helper maps (depth, skill, randomness)
        -------------------------------------------------- */
        // track selected player color globally
        let playerColor = 'white';
        function depthForElo(elo) {
            // console.log('Elo:', elo);
            if (elo < 300) return 1;
            if (elo < 500) return 2;
            if (elo < 700) return 2;  // weakened from 3
            if (elo < 900) return 3;  // weakened from 4
            if (elo < 1100) return 4; // weakened from 5
            return 5; // weakened from 6 (1100–1319)
        }

        function skillForElo(elo) {
            // console.log('Elo:', elo);
            // Stockfish Skill Level 0‑20 (0 weakest)
            if (elo < 300) return 0;
            if (elo < 500) return 1;
            if (elo < 700) return 2;  // weakened from 3
            if (elo < 900) return 4;  // weakened from 5
            if (elo < 1100) return 6; // weakened from 8
            return 10; // weakened from 12 (1100–1319)
        }

        function randomChanceForElo(elo) {
            // console.log('Elo:', elo);
            if (elo < 300) return 0.8;  // 60 % random
            if (elo < 500) return 0.4;   // 30 %
            if (elo < 700) return 0.2;   // 10 % randomness for <700
            if (elo < 900) return 0.1;   // slight randomness for <900
            return 0; // ≥900 – deterministic
        }

        /* --------------------------------------------------
           DOM prep – hide board until started
        -------------------------------------------------- */
        document.getElementById('board').style.display = 'none';
        document.getElementById('status').style.display = 'none';
        // slider display update
        document.getElementById('minPlies').addEventListener('input', e => {
            document.getElementById('minPliesValue').textContent = e.target.value;
        });
        document.getElementById('maxPlies').addEventListener('input', e => {
            document.getElementById('maxPliesValue').textContent = e.target.value;
        });
        document.getElementById('advantage').addEventListener('input', e => {
            document.getElementById('advantageValue').textContent = e.target.value;
        });
        // initialize slider display and thumb positions
        ['minPlies', 'maxPlies', 'advantage'].forEach(id => {
            const el = document.getElementById(id);
            el.value = el.defaultValue;
            el.dispatchEvent(new Event('input'));
        });

        /* --------------------------------------------------
           Globals
        -------------------------------------------------- */
        const STOCKFISH_CDN = 'https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.min.js';
        let engine, ready = false, currentElo = 1200;

        /* --------------------------------------------------
           Utility: send command & log to console
        -------------------------------------------------- */
        function sfSend(cmd) {
            console.log('%c[SEND] ' + cmd, 'color:#0a0');
            engine.postMessage(cmd);
        }

        /* --------------------------------------------------
           Inline form submission and API integration
        -------------------------------------------------- */
        document.getElementById('generateBtn').addEventListener('click', async () => {
            // set global player color (handle random)
            const selected = document.getElementById('playerColor').value;
            if (selected === 'random') {
                playerColor = Math.random() < 0.5 ? 'white' : 'black';
            } else {
                playerColor = selected;
            }
            const elo = parseInt(document.getElementById('elo').value, 10);
            const minPlies = parseInt(document.getElementById('minPlies').value, 10);
            const maxPlies = parseInt(document.getElementById('maxPlies').value, 10);
            // calculate signed target from slider (-25 to +25) * 100, flip sign if playing black
            const adv = parseInt(document.getElementById('advantage').value, 10);
            let target = adv * 100 * (playerColor === 'white' ? 1 : -1);

            // hide controls container and show board
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.controls').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            document.getElementById('board').style.display = 'block';
            document.getElementById('status').style.display = 'block';
            document.getElementById('status').textContent = 'loading...';

            try {
                // stream positions via WebSocket
                const sock = new WebSocket('ws://95.217.47.119:8000/ws/generate_board');
                sock.onopen = () => sock.send(JSON.stringify({ target, elo, min_plies: minPlies, max_plies: maxPlies }));
                let first = true;
                sock.onmessage = e => {
                    const { fen } = JSON.parse(e.data);
                    chess.load(fen);
                    if (first) { board.orientation(playerColor); first = false; }
                    board.position(fen, true);
                    // status remains 'loading...' while streaming
                };
                sock.onclose = () => {
                    // after streaming, show next turn and start engine
                    const turnMsg = chess.turn() === 'w' ? 'White to move' : 'Black to move';
                    document.getElementById('status').textContent = turnMsg;
                    startGameEngine();
                };
            } catch (err) {
                alert('Error streaming board: ' + err.message);
                console.error(err);
            }
        });

        // Function to start the game engine (extracted from original start button logic)
        function startGameEngine() {
            document.querySelector('.controls').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            document.getElementById('board').style.display = 'block';
            document.getElementById('status').style.display = 'block';
            // status remains as set by onclose; engine hook will update once ready

            fetch(STOCKFISH_CDN, { mode: 'cors' })
                .then(r => r.text())
                .then(code => {
                    const blobURL = URL.createObjectURL(new Blob([code], { type: 'application/javascript' }));
                    engine = new Worker(blobURL);
                    hookEngine();
                })
                .catch(err => alert('Failed to load Stockfish: ' + err));
        }

        /* --------------------------------------------------
           Boot engine (original logic moved to startGameEngine)
        -------------------------------------------------- */

        /* --------------------------------------------------
           Handle engine output
        -------------------------------------------------- */
        function hookEngine() {
            engine.onmessage = e => {
                const line = typeof e.data === 'string' ? e.data : e.data?.toString();
                console.log('%c[SF]   ' + line, 'color:#09f');

                if (line === 'uciok') {
                    applyStrength();
                    ready = true;
                    // engine moves when it's engine's turn (opposite of player's)
                    const engineTurn = playerColor === 'white' ? 'b' : 'w';
                    if (chess.turn() === engineTurn) moveEngine();
                    return;
                }

                if (line === 'readyok') return;

                if (line.startsWith('bestmove')) {
                    const best = line.split(' ')[1];
                    chess.move({ from: best.slice(0, 2), to: best.slice(2, 4), promotion: 'q' });
                    board.position(chess.fen());
                    updateStatus();
                }
            };
            sfSend('uci');
        }

        /* --------------------------------------------------
           Apply strength settings each time elo changes
        -------------------------------------------------- */
        function applyStrength() {
            const s = document.getElementById('status');

            // Always set skill level (exists in this build)
            const skill = currentElo >= 1320 ? 20 : skillForElo(currentElo);
            sfSend('setoption name Skill Level value ' + skill);

            if (currentElo >= 3000) {
                // Full engine strength
                sfSend('setoption name UCI_LimitStrength value false');
                s.textContent = 'Full engine strength';
            } else if (currentElo >= 1320) {
                // Limit engine to target Elo
                sfSend('setoption name UCI_LimitStrength value true');
                sfSend('setoption name UCI_Elo value ' + currentElo);
            } else {
                // lower Elo: skill+depth caps
                sfSend('setoption name UCI_LimitStrength value false');
            }
            sfSend('isready');
        }

        /* --------------------------------------------------
           Elo slider change handler
        -------------------------------------------------- */
        document.getElementById('elo').addEventListener('change', () => {
            currentElo = parseInt(document.getElementById('elo').value, 10);
            if (ready) applyStrength();
        });

        /* --------------------------------------------------
           Chessboard init
        -------------------------------------------------- */
        const chess = new Chess();
        const board = Chessboard('board', {
            draggable: true,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
            position: 'start',
            onDragStart,
            onDrop,
            onSnapEnd: () => board.position(chess.fen())
        });

        updateStatus();

        /* --------------------------------------------------
           Mobile touch handling - prevent page scrolling on board
        -------------------------------------------------- */
        function preventMobileScrolling() {
            const boardElement = document.getElementById('board');
            
            // Prevent default touch behaviors on the board
            boardElement.addEventListener('touchstart', function(e) {
                e.preventDefault();
            }, { passive: false });
            
            boardElement.addEventListener('touchmove', function(e) {
                e.preventDefault();
            }, { passive: false });
            
            boardElement.addEventListener('touchend', function(e) {
                e.preventDefault();
            }, { passive: false });
        }

        // Apply mobile touch handling after a short delay to ensure board is rendered
        setTimeout(preventMobileScrolling, 100);

        /* --------------------------------------------------
           Drag callbacks
        -------------------------------------------------- */
        function onDragStart(src, piece) {
            return !chess.game_over() &&
                !((chess.turn() === 'w' && piece[0] === 'b') || (chess.turn() === 'b' && piece[0] === 'w'));
        }

        function onDrop(src, tgt) {
            const mv = chess.move({ from: src, to: tgt, promotion: 'q' });
            if (!mv) return 'snapback';
            updateStatus();
            setTimeout(moveEngine, 200);
        }

        /* --------------------------------------------------
           Engine move logic with randomness
        -------------------------------------------------- */
        function moveEngine() {
            if (!ready || chess.game_over()) return;

            // Chance for a pure random move instead of engine search
            const randChance = randomChanceForElo(currentElo);
            if (Math.random() < randChance) {
                const moves = chess.moves();
                const pick = moves[Math.floor(Math.random() * moves.length)];
                chess.move(pick);
                board.position(chess.fen());
                updateStatus();
                return;
            }

            sfSend('position fen ' + chess.fen());

            if (currentElo < 1320) {
                const depth = depthForElo(currentElo);
                sfSend('go depth ' + depth);
            } else {
                sfSend('go movetime 1000');
            }
        }

        /* --------------------------------------------------
           UI Status helper
        -------------------------------------------------- */
        function updateStatus() {
            const s = document.getElementById('status');
            const turn = chess.turn() === 'b' ? 'Black' : 'White';
            s.textContent = chess.in_checkmate() ? `Game over – ${turn} is checkmated.` :
                chess.in_stalemate() ? 'Game over – stalemate.' :
                    chess.insufficient_material() ? 'Game over – insufficient material (draw).' :
                        chess.in_draw() ? 'Game over – draw.' :
                            `${turn} to move${chess.in_check() ? `, ${turn} in check!` : ''}`;

        }
    }); // end DOMContentLoaded
    </script>
</body>

</html>